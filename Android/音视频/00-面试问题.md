
[雷霄骅](https://blog.csdn.net/leixiaohua1020)

VideoEye(雷霄骅的软件，分析视频帧)


## 为什么需要视频编解码

摄像头麦克风采集的原始数据(视频数据YUV、RGB；音频PCM数据)太大，有很多冗余数据，为了方便存储和传输，需要将采集的原始数据进行编码，视频数据通常采用H264编解码(免费所以使用最多)，音频采用AAC编解码。

对音视频分别进行编码后，让音频轨和视频轨按照一定的格式封装到一个容器中，就得到我们常见的视频文件，常用的封装格式有AVI(文件格式.avi)、WMV(.wmv)、MPEG(.mp4、.mpg等)、Matroska(.mkv)、Real Video(.rm、.rmvb)、QuickTime File Format(.mov)等。

播放器在播放视频文件(封装格式)时，首先要对其解封装将视频压缩数据(.h264)和音频压缩数据(.aac)分离出来，然后分别对其解码，最后将视频像素数据绘制在屏幕，音频采样数据输出到扬声器。

## 你们做视频是用ffmpeg播放的吗

ffmpeg是软解码，消耗CPU，性能差，手机发热。

Android提供了MediaEncoder可以硬解码。移动端Soc芯片里面集成了CPU、GPU、DSP、SP、ISP、RAM内存、wifi控制器、基带芯片及DSP音视频芯片等，其中DSP主要就是用来音视频的解码工作（硬解码），它的出现是为了分担CPU的工作的。

硬解码指系统将mp4(举例)文件分离成.h264视频数据流和.aac音频数据流，然后再将两个数据流交给DSP芯片进行处理，DSP将处理好的一帧帧画面转交给GPU/CPU显示在屏幕上。

## H264压缩技术

H264的基本原理其实非常简单，通过摄像头采集到的视频帧(按30帧/s)，被送到h264编码器的缓冲区，编码器首先对每个图片划分宏块（信源编码器对一帧图片划分宏块），H264默认使用16x16(像素)大小的区域作为一个宏块，也可以划分成8x8大小。只保存上边和左边的像素，通过帧内预测、运动补偿等技术，只保留关键的数据（I帧、P帧、B帧），I帧是关键帧保留整个画面像素数据，通常只有切换场景的时候才会出现I帧。

常见的视频帧有I、P、B帧，I帧表示关键帧，是画面完整保留的帧。P帧(差别帧)表示这一帧和之前一个关键帧的差别，解码时需要用之前缓存的画面叠加本帧定义的差别生成最终画面。B帧是双向差别帧，记录本帧与前后帧的差别。B帧压缩率高，但是解码时CPU比较吃力。

与I帧相似程度极高达到95%以上编码成B帧，70%相似度编码为P帧，I帧和P帧之间有B帧做过度，通常I帧和P帧之间有多个B帧，两个I帧之间有多个B和P帧。

除了I/P/B帧外，还有图像序列GOP，GOP图像序列可以理解为一个场景，场景的物体都是相似的，两个I帧之间是一个图像序列，一个图像序列中只有一个I帧，GOP越短I帧越多，视频文件越大。抖音视频的GOP是比较大的就是为了控制视频大小。

h264文件就是保存的这些IBP帧数据以及一些协议数据，使用16进制打开分析


## H264码流分析

[h264百度百科](https://baike.baidu.com/item/H.264/1022230?fromtitle=H264&fromid=7338504&fr=aladdin)

H264Visa软件，专门用来分析.h264码流的

H.264的编码视频序列包括一系列的NAL单元，每个NAL单元包含一个RBSP。一个原始h264由N个NALU单元组成，NALU单元常由[StartCode][NALU Header][NALU Payload]三部分组成，启动StartCode用于标记这是一个NALU单元的开始，必须是'00 00 00 01'或'00 00 01'








