å‚è€ƒï¼š

[æ‰”ç‰©çº¿ï¼ˆæœ±å‡¯ï¼‰Kotlin çš„åç¨‹ç”¨åŠ›ç¥ä¸€çœ¼](https://kaixue.io/kotlin-coroutines-1/)
[Kotlinåç¨‹è®¾è®¡ææ¡ˆ](https://github.com/Kotlin-zh/KEEP/blob/master/proposals/coroutines.md)
[Kotlinåç¨‹æŒ‡å—](https://www.kotlincn.net/docs/reference/coroutines/coroutines-guide.html)
[Kotlinåç¨‹æ–‡æ¡£](https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/index.html)
[Androidä¸Šçš„Kotlinåç¨‹](https://developer.android.google.cn/kotlin/coroutines)




> ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºopenXuåŸåˆ›æ–‡ç« [ã€openXuçš„åšå®¢ã€‘](http://blog.csdn.net/xmxkf)ï¼Œæœªç»åšä¸»å…è®¸ä¸å¾—ä»¥ä»»ä½•å½¢å¼è½¬è½½

@[toc]


å…¬å¸é¡¹ç›®ä¸­ä½¿ç”¨åç¨‹å·²ç»æœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œåˆšå¼€å§‹æ¥è§¦åç¨‹çš„æ—¶å€™ä¹Ÿå’Œå…¶ä»–åšAndroidçš„å°ä¼™ä¼´æœ‰ç›¸åŒçš„å¿ƒç†æ´»åŠ¨ï¼šGoogleçˆ¸çˆ¸ï¼Œçƒçƒä½ ä¸è¦å†å‡ºæ–°ä¸œè¥¿äº†ï¼Œå­¦ä¸åŠ¨äº†ã€‚ä¸ç®¡å½“åˆæˆ‘æ˜¯æ€æ ·æ‹’ç»å®ƒçš„ï¼Œä½†æ˜¯ç°åœ¨æˆ‘åªèƒ½è¯´ï¼šå—¯  åç¨‹çœŸé¦™ï¼æ¥è§¦åç¨‹çš„æ—¶å€™åœ¨ç½‘ä¸Šæœç´¢äº†ä¸€äº›æ–‡ç« ï¼Œæœ‰çš„æ–‡ç« æ˜¯å¾ˆæ—©ä»¥å‰çš„ï¼Œä¼°è®¡ä½œè€…å†™æ–‡ç« çš„æ—¶å€™ä¹Ÿå¹¶æ²¡æœ‰çœŸæ­£ç†è§£åç¨‹ï¼Œè¿˜æœ‰ä¸€äº›æ–‡ç« é€šä¿—æ˜“æ‡‚ä½†æ˜¯ä¸å¤Ÿæ·±å…¥ã€‚æ‰€ä»¥ç¬”è€…æ‰“ç®—é€šè¿‡å‡ ç¯‡æ–‡ç« æ¥è®°å½•æœ¬äººé€šè¿‡kotlinæºç æ·±å…¥åç¨‹çš„è¿‡ç¨‹ï¼Œå¸Œæœ›å¯¹æƒ³äº†è§£åç¨‹çš„äººæœ‰æ‰€å¸®åŠ©ã€‚

# 1. ä»€ä¹ˆæ˜¯åç¨‹

è™½ç„¶å¯¹äºä¸€äº›äººæ¥è¯´æ¯”å¦‚åˆšå¼€å§‹çš„æˆ‘ï¼Œ**åç¨‹(Coroutines)**æ˜¯ä¸€ä¸ªæ–°çš„æ¦‚å¿µï¼Œä½†æ˜¯åç¨‹è¿™ä¸ªæœ¯è¯­æ—©åœ¨1958å¹´å°±è¢«æå‡ºå¹¶ç”¨äºæ„å»ºæ±‡ç¼–ç¨‹åºï¼Œåç¨‹æ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼Œå¹¶ä¸å±€é™äºç‰¹å®šçš„è¯­è¨€ï¼Œå°±åƒRxä¹Ÿæ˜¯ä¸€ç§æ€æƒ³ï¼Œå¹¶ä¸å±€é™äºä½¿ç”¨Javaå®ç°çš„RxJavaã€‚ä¸åŒè¯­è¨€å®ç°çš„åç¨‹åº“å¯èƒ½åç§°æˆ–è€…ä½¿ç”¨ä¸Šæœ‰æ‰€ä¸åŒï¼Œä½†å®ƒä»¬çš„è®¾è®¡æ€æƒ³æ˜¯æœ‰ç›¸ä¼¼ä¹‹å¤„çš„ã€‚

`kotlinx.coroutines`æ˜¯ç”±JetBrainså¼€å‘çš„kotlinåç¨‹åº“ï¼Œå¯ä»¥æŠŠå®ƒç®€å•çš„ç†è§£ä¸ºä¸€ä¸ª**çº¿ç¨‹æ¡†æ¶**ã€‚ä½†æ˜¯åç¨‹ä¸æ˜¯çº¿ç¨‹ï¼Œä¹Ÿä¸æ˜¯æ–°ç‰ˆæœ¬çš„çº¿ç¨‹ï¼Œå®ƒæ˜¯åŸºäºçº¿ç¨‹å°è£…çš„ä¸€å¥—æ›´ä¸Šå±‚å·¥å…·åº“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨kotlinåç¨‹åº“æä¾›çš„apiæ–¹ä¾¿çš„çµæ´»çš„æŒ‡å®šåç¨‹ä¸­ä»£ç æ‰§è¡Œçš„çº¿ç¨‹ã€åˆ‡æ¢çº¿ç¨‹ï¼Œä½†æ˜¯ä¸éœ€è¦æ¥è§¦çº¿ç¨‹Threadç±»ã€‚è¯´åˆ°è¿™é‡Œï¼Œå¤§å®¶å¯èƒ½å°±ä¼šæƒ³åˆ°Androidçš„`AsyncTask`æˆ–è€…RxJavaçš„`Schedulers`ï¼Œæ²¡é”™ï¼Œä»æŸç§æ„ä¹‰ä¸Šæ¥è¯´å®ƒä»¬å’Œåç¨‹æ˜¯ç›¸é€šçš„ï¼Œéƒ½è§£å†³äº†å¼‚æ­¥çº¿ç¨‹åˆ‡æ¢çš„é—®é¢˜ï¼Œç„¶è€Œ**åç¨‹æœ€é‡è¦çš„æ˜¯é€šè¿‡éé˜»å¡æŒ‚èµ·å’Œæ¢å¤å®ç°äº†å¼‚æ­¥ä»£ç çš„åŒæ­¥ç¼–å†™æ–¹å¼ï¼ŒæŠŠåŸæœ¬è¿è¡Œåœ¨ä¸åŒçº¿ç¨‹çš„ä»£ç å†™åœ¨ä¸€ä¸ªä»£ç å—{}é‡Œï¼Œçœ‹èµ·æ¥å°±åƒæ˜¯åŒæ­¥ä»£ç ã€‚**

```kotlin
MainScope().launch(){     //åœ¨UIçº¿ç¨‹ä¸­å¯åŠ¨åç¨‹
    //ä¸‹é¢çš„ä»£ç çœ‹èµ·æ¥ä¼šä»¥åŒæ­¥çš„æ–¹å¼ä¸€è¡Œè¡Œæ‰§è¡Œï¼ˆå¼‚æ­¥ä»£ç åŒæ­¥è·å–ç»“æœï¼‰
    val token = apiService.getToken()   // ç½‘ç»œè¯·æ±‚ï¼šIOçº¿ç¨‹ï¼Œè·å–ç”¨æˆ·token
    val user = apiService.getUser(token)// ç½‘ç»œè¯·æ±‚ï¼šIOçº¿ç¨‹ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
    nameTv.text = user.name             // æ›´æ–° UIï¼šä¸»çº¿ç¨‹ï¼Œå±•ç¤ºç”¨æˆ·å
    val articles = apiService.getUserArticle(user.id)// ç½‘ç»œè¯·æ±‚ï¼šIOçº¿ç¨‹ï¼Œæ ¹æ®ç”¨æˆ·idè·å–ç”¨æˆ·å†™çš„æ–‡ç« 
    articleTv.text = "ç”¨æˆ·${user.name}æ€»å…±å†™äº†${articles.size}ç¯‡æ–‡ç« "   // æ›´æ–° UIï¼šä¸»çº¿ç¨‹
}
```

åç¨‹å¹¶ä¸æ˜¯ä»æ“ä½œç³»ç»Ÿå±‚é¢åˆ›ç«‹çš„æ–°çš„è¿è¡Œæ–¹å¼ï¼Œä»£ç æ˜¯è¿è¡Œåœ¨çº¿ç¨‹ä¸­çš„ï¼Œçº¿ç¨‹åˆæ˜¯è¿è¡Œåœ¨è¿›ç¨‹ä¸­çš„ï¼Œåç¨‹ä¹Ÿæ˜¯è¿è¡Œåœ¨çº¿ç¨‹ä¸­çš„ï¼Œæ‰€ä»¥æ‰è¯´å®ƒæ˜¯åŸºäºçº¿ç¨‹å°è£…çš„åº“ã€‚ç„¶è€Œæœ‰äººä¼šæ‹¿åç¨‹ä¸çº¿ç¨‹æ¯”è¾ƒï¼Œé—®åç¨‹æ˜¯ä¸æ˜¯æ¯”çº¿ç¨‹æ•ˆç‡æ›´é«˜ï¼Ÿå¦‚æœç†è§£äº†åç¨‹æ˜¯åŸºäºçº¿ç¨‹å°è£…å°±åº”è¯¥çŸ¥é“ï¼Œåç¨‹å¹¶æ²¡æœ‰æ”¹å˜ä»£ç è¿è¡Œåœ¨çº¿ç¨‹ä¸­çš„åŸåˆ™ï¼Œå•çº¿ç¨‹ä¸­çš„åç¨‹æ‰§è¡Œæ—¶é—´å¹¶ä¸ä¼šæ¯”ä¸ç”¨åç¨‹å°‘ï¼Œå®ƒä»¬ä¹‹é—´æ²¡æœ‰å¯æ¯”æ€§ï¼Œå› ä¸ºå®ƒä»¬æ ¹æœ¬ä¸å±äºåŒä¸€ç±»äº‹ç‰©ï¼›åç¨‹ä¹Ÿä¸æ˜¯ä¸ºäº†çº¿ç¨‹è€Œç”Ÿçš„ï¼Œå®ƒæ˜¯ä¸ºäº†è§£å†³å› ä¸ºå¤šçº¿ç¨‹å¸¦æ¥çš„ç¼–ç ä¸Šçš„ä¸ä¾¿çš„é—®é¢˜è€Œå‡ºç°çš„ã€‚

ç„¶è€Œè¯´åˆ°è¿™é‡Œä¼°è®¡æœ‰äº›äººè¿˜æ˜¯äº‘é‡Œé›¾é‡Œçš„ï¼Œä¸‹é¢è¿˜æ˜¯é€šè¿‡åº¸ä¿—çš„ç¤ºä¾‹æ¥ä¸æ»‘çš„è®¤è¯†åç¨‹

# 2. åç¨‹æœ‰ä»€ä¹ˆä½œç”¨

åœ¨Androidå¼€å‘ä¸­ï¼Œé€šå¸¸ä¼šå°†è€—æ—¶æ“ä½œæ”¾åˆ°å­çº¿ç¨‹ä¸­ï¼Œç„¶åé€šè¿‡å›è°ƒçš„æ–¹å¼å°†ç»“æœè¿”å›ååˆ‡æ¢ä¸»çº¿ç¨‹æ›´æ–°UIï¼Œä½†æ˜¯å®é™…å¼€å‘è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°å¾ˆå¤šå¥‡æ€ªè€Œåˆç†çš„éœ€æ±‚ï¼Œå®ƒä»¬å¯èƒ½æ˜¯ï¼š

1. ä¸€ä¸ªé¡µé¢éœ€è¦åŒæ—¶å¹¶å‘è¯·æ±‚å¤šä¸ªæ¥å£ï¼Œå½“æ‰€æœ‰æ¥å£éƒ½è¯·æ±‚å®Œæˆéœ€è¦åšä¸€äº›åˆå¹¶å¤„ç†ç„¶åæ›´æ–°UI

- æŒ‰ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä¸ºæ¯ä¸ªæ¥å£è¯·æ±‚è®¾ç½®ä¸€ä¸ªbooleanæ ‡å¿—ï¼Œæ¯å½“ä¸€ä¸ªæ¥å£è¯·æ±‚å®Œå°†å¯¹åº”çš„booleanå€¼æ”¹ä¸ºtrueï¼Œå½“æœ€åä¸€ä¸ªæ¥å£è¯·æ±‚å®Œæˆå‘ç°æ‰€æœ‰æ ‡å¿—éƒ½ä¸ºtrueå†æ›´æ–°UIï¼Œè¿™æ ·å°±èƒ½è¾¾åˆ°å¹¶å‘è¯·æ±‚çš„ç›®çš„ï¼Œç„¶è€Œç®¡ç†è¿™ä¹ˆå¤šbooleanå€¼ç´¯ä¸ç´¯ï¼Ÿä¼˜é›…ä¸ä¼˜é›…ï¼Ÿ
- åˆçº§ç¨‹åºå‘˜å¯èƒ½å¹²è„†æ¥ä¸ªå•çº¿ç¨‹ï¼Œä¸€ä¸ªæ¥å£è¯·æ±‚å®Œæˆåï¼Œå†è¯·æ±‚å¦ä¸€ä¸ªæ¥å£ï¼Œç›´åˆ°æœ€åä¸€ä¸ªæ¥å£è¿”å›æ•°æ®ï¼Œç©æš´åŠ›ç¾å­¦å•Šï¼Œæœ¬æ¥èƒ½åŒæ—¶å¹²çš„äº‹æƒ…éå¾—ä¸€ä»¶ä»¶å¹²ï¼Œä½ è®©ç”¨æˆ·æµªè´¹ä»–å®è´µçš„æ—¶é—´åˆé€‚å—ï¼Ÿæµªè´¹ç”¨æˆ·é«˜é…çš„æ€§èƒ½è¿‡ç˜¾å—ï¼Ÿ
- é«˜çº§ä¸€ç‚¹çš„å¯èƒ½å°±ä¸ŠRxJavaäº†ï¼Œé€šè¿‡RxJavaçš„zipæ“ä½œç¬¦ï¼Œè¾¾åˆ°å‘å°„ä¸€æ¬¡ï¼Œå°†ç»“æœåˆå¹¶å¤„ç†çš„ç›®çš„ï¼Œä½†æ˜¯è¯´å®è¯åˆ°ç°åœ¨è¿˜æœ‰å¾ˆå¤šäººä¸ä¼šç”¨RxJava

2. å…ˆè°ƒç”¨æ¥å£1è·å–æ•°æ®ï¼Œç„¶åæ‹¿åˆ°æ¥å£1çš„ç»“æœä½œä¸ºå‚æ•°è°ƒç”¨æ¥å£2ï¼Œç„¶åå°†æ¥å£2çš„æ•°æ®å±•ç¤ºå‡ºæ¥

- æŒ‰ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè°ƒç”¨æ¥å£1ï¼Œç„¶ååœ¨æ¥å£1çš„å›è°ƒä¸­è·å–æ•°æ®å†åµŒå¥—è°ƒç”¨æ¥å£2
- é«˜çº§ä¸€ç‚¹çš„å¯èƒ½å°±ä¸ŠRxJavaäº†

......éƒ½æ˜¯ä¸€æ ·çš„å¥—è·¯ï¼Œæ²¡æœ‰ä¸€ç‚¹æ–°èŠ±æ ·å—ï¼Ÿ/(ã„’oã„’)/~~è¿˜çœŸæ²¡æœ‰ï¼Œé‚£å°±ä»¥ç¬¬2ä¸ªéœ€æ±‚ä¸ºæ —å­ç»§ç»­å§

## 2.1 å›è°ƒåœ°ç‹±

éœ€æ±‚ï¼šé¡µé¢ä¸Šéœ€è¦å±•ç¤ºæ–‡ç« åˆ—è¡¨ï¼Œè€Œè·å–æ–‡ç« åˆ—è¡¨ä¹‹å‰è¦å…ˆè·å–åˆ°æ–‡ç« æ ‘ç»“æ„ï¼Œæ‹¿åˆ°æ ‘ä¸‹çš„ç¬¬ä¸€ä¸ªåˆ†æ”¯idï¼Œç„¶åé€šè¿‡åˆ†æ”¯idè·å–åˆ†æ”¯ä¸‹çš„ç¬¬ä¸€é¡µæ–‡ç« ä½œä¸ºé»˜è®¤å±•ç¤ºå†…å®¹ã€‚

é€šè¿‡Retrofitè¯·æ±‚çš„é€»è¾‘å¦‚ä¸‹ï¼š

> æ­¤å¤„å€Ÿç”¨[wanandroidå¼€æ”¾çš„æ¥å£](https://www.wanandroid.com/blog/show/2)ï¼Œåªæ˜¯ç®€å•çš„å®ç°è¿™ä¸ªä¸šåŠ¡é€»è¾‘ï¼Œå¯¹æ¡†æ¶å°è£…å¹¶ä¸å®Œå–„ï¼Œæ¯”å¦‚é”™è¯¯å¤„ç†ç­‰ç­‰ï¼Œåªéœ€è¦é¢†ä¼šåµŒå¥—å›è°ƒå³å¯

```kotlin
/**RetrofitClientå•ä¾‹*/
object RetrofitClient {
    /**log**/
    private val logger = HttpLoggingInterceptor.Logger {
        FLog.i(this::class.simpleName, it)
    }
    private val logInterceptor = HttpLoggingInterceptor(logger).apply {
        level = HttpLoggingInterceptor.Level.BODY
    }

    /**OkhttpClient*/
    private val okHttpClient = OkHttpClient.Builder()
            .callTimeout(10, TimeUnit.SECONDS)
            .addNetworkInterceptor(logInterceptor)
            .build()
    /**Retrofit*/
    private val retrofit = Retrofit.Builder()
        .client(okHttpClient)
        .baseUrl(ApiService.BASE_URL)
        .addCallAdapterFactory(RxJava3CallAdapterFactory.create())
        .addConverterFactory(GsonConverterFactory.create())
        .build()
    /**ApiService*/
    val apiService: ApiService = retrofit.create(ApiService::class.java)
}

/**æ¥å£å®šä¹‰*/
interface ApiService {
	companion object {
        const val BASE_URL = "https://www.wanandroid.com"
    }
    /*è·å–æ–‡ç« æ ‘ç»“æ„*/
    @GET("tree/json")
    fun getTree(): Call<ApiResult<MutableList<Tree>>>

    /*æ ¹æ®æ•°ç»“æ„ä¸‹æŸä¸ªåˆ†æ”¯idï¼Œè·å–åˆ†æ”¯ä¸‹çš„æ–‡ç« */
    @GET("article/list/{page}/json")
    fun getArticleList(
            @Path("page") page: Int,
            @Query("cid") cid: Int
    ): Call<ApiResult<Pagination<Article>>>
}

/**ViewModel*/
class SystemViewModel : BaseViewModel(){
    private val remoteRepository : SystemRemoteRepository by lazy { SystemRemoteRepository() }

    val page = MutableLiveData<Pagination<Article>>()

    fun getArticleList() {
       remoteRepository.getArticleList(){
           page.value = it
       }
   }
}

/**æ•°æ®ä»“åº“*/
class SystemRemoteRepository{
	/**
	 * 1. å±•ç¤ºå›è°ƒåµŒå¥—ï¼Œå›è°ƒåœ°ç‹±
	 */
	fun getArticleList(responseBack: (result: Pagination<Article>?) -> Unit) {
	        /**1. è·å–æ–‡ç« æ ‘ç»“æ„*/
	        val call:Call<ApiResult<MutableList<Tree>>> = RetrofitClient.apiService.getTree()
	        //åŒæ­¥ï¼ˆéœ€è¦è‡ªå·±æ‰‹åŠ¨åˆ‡æ¢çº¿ç¨‹ï¼‰
	        //val response : Response<ApiResult<MutableList<Tree>>> = call.execute()
	        //å¼‚æ­¥å›è°ƒ
	        call.enqueue(object : Callback<ApiResult<MutableList<Tree>>> {
	            override fun onFailure(call: Call<ApiResult<MutableList<Tree>>>, t: Throwable) {
	            }
	            override fun onResponse(call: Call<ApiResult<MutableList<Tree>>>, response: Response<ApiResult<MutableList<Tree>>>) {
	                FLog.v("è¯·æ±‚æ–‡ç« æ ‘ç»“æ„æˆåŠŸï¼š"+response.body())

	                /**2. è·å–åˆ†æ”¯idä¸‹çš„ç¬¬ä¸€é¡µæ–‡ç« */
	                val treeid = response.body()?.data?.get(0)?.id
	                //å½“treeidä¸ä¸ºnullæ‰§è¡Œ
	                treeid?.let {
	                    RetrofitClient.apiService.getArticleList(0, treeid)
	                            .enqueue(object : Callback<ApiResult<Pagination<Article>>> {
	                                override fun onFailure(call: Call<ApiResult<Pagination<Article>>>, t: Throwable) {
	                                }
	                                override fun onResponse(call: Call<ApiResult<Pagination<Article>>>, response: Response<ApiResult<Pagination<Article>>>) {
	                                    //è¿”å›è·å–çš„æ–‡ç« åˆ—è¡¨
	                                    responseBack(response.body()?.data)
	                                }
	                            })
	                }

	            }
	        })
	    }
}
```

å…¶å®ä¸Šé¢æ•°æ®ä»“åº“ä¸­çš„æ–¹æ³•æ˜¯åº”è¯¥æ‹†åˆ†ä¸º2ä¸ªæ–¹æ³•çš„ï¼Œç¬¬äºŒä¸ªæ¥å£è¯·æ±‚æ‹†åˆ†ä¸ºæ–¹æ³•åè¿˜å¯ä»¥å¤ç”¨ï¼ˆåˆ†é¡µè·å–ï¼‰ï¼Œè¿™é‡Œä»…ä»…ä¸ºäº†å±•ç¤ºåµŒå¥—å›è°ƒçš„éœ€æ±‚ã€‚å¯ä»¥çœ‹åˆ°ä»…ä»…æ˜¯ä¸¤å±‚å›è°ƒåµŒå¥—ï¼Œå¯è¯»æ€§å°±å·²ç»å¾ˆå·®äº†ï¼Œç„¶è€Œè¿™ç§éœ€æ±‚å¹¶éä¸å¸¸è§çš„ç”šè‡³ä¼šå‡ºç°æ›´å¤šå±‚åµŒå¥—ï¼Œè¿™æ—¶å€™å°±ä¼šå†™å‡º**æ·±>å½¢**çš„ä»£ç ï¼Œéå¸¸ä¸é›…è§‚è€Œä¸”ä¸æ˜“äºä»£ç å¤ç”¨åŠåæœŸç»´æŠ¤ã€‚

æœ‰äººä¼šè¯´å°†ä¸Šé¢çš„åµŒå¥—å›è°ƒæ‹†åˆ†ä¸º2ä¸ªæ–¹æ³•ï¼Œåœ¨ç¬¬ä¸€ä¸ªæ¥å£è¯·æ±‚å®Œæˆä¹‹åå†è°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•è¯·æ±‚æ–‡ç« åˆ—è¡¨ï¼Œè¿™ä¸å°±æ¶ˆé™¤äº†åµŒå¥—å›è°ƒäº†å—ï¼Ÿä»è§†è§‰ä¸Šæ¥è¯´ç¡®å®æ˜¯æ¶ˆé™¤äº†ï¼Œä½†æ˜¯ä»é€»è¾‘ä¸Šæ¥è¯´åµŒå¥—ä¾ç„¶å­˜åœ¨ï¼Œè€Œä¸”è¿™ç§æ–¹å¼ä¼šè®©ä¸¤ä¸ªæ–¹æ³•ä¹‹é—´å½¢æˆå¾ˆå¼ºçš„ä¸šåŠ¡å…³è”ï¼Œå¯¹ä»£ç ç»´æŠ¤å¸¦æ¥çš„æŒ‘æˆ˜ä¸æ¯”åµŒå¥—å›è°ƒå°ã€‚ä»£ç å°±ä¸å±•ç¤ºäº†ï¼Œå°±æ˜¯ç®€å•çš„å°†ä¸¤ä¸ªè¯·æ±‚æ‹†åˆ†ã€‚

## 2.2 Rxè§£å†³å›è°ƒåœ°ç‹±

è¿˜æœ‰äººè¯´ï¼Œä½¿ç”¨Retrofit+RxJavaç»„åˆé€šè¿‡Rxçš„é“¾å¼è°ƒç”¨å°±èƒ½æ¶ˆé™¤åµŒå¥—å›è°ƒï¼š

```kotlin
interface ApiService {
	...
    /**RxJavaæ–¹å¼*/
    @GET("tree/json")
    fun getTreeByRx(): Observable<ApiResult<MutableList<Tree>>>

    @GET("article/list/{page}/json")
    fun getArticleListByRx(
        @Path("page") page: Int,
        @Query("cid") cid: Int
    ): Observable<ApiResult<Pagination<Article>>>
}

class SystemRemoteRepository{
	/**
	 * 2. Retrofit+RxJavaæ¶ˆé™¤å›è°ƒåµŒå¥—
	 */
	fun getArticleListByRx(responseBack: (result: Pagination<Article>?) -> Unit) {
	    /**1. è·å–æ–‡ç« æ ‘ç»“æ„*/
	    val observable1: Observable<ApiResult<MutableList<Tree>>> = RetrofitClient.apiService.getTreeByRx()
	    observable1.subscribeOn(Schedulers.io())
	            .observeOn(AndroidSchedulers.mainThread())
	            //ä½¿ç”¨å½“å‰Observableå‘å‡ºçš„å€¼è°ƒç”¨ç»™å®šçš„Consumerï¼Œç„¶åå°†å…¶è½¬å‘ç»™ä¸‹æ¸¸
	            .doOnNext({
	                FLog.v("1è¯·æ±‚æ–‡ç« æ ‘æˆåŠŸï¼Œåˆ‡æ¢åˆ°ä¸»çº¿ç¨‹å¤„ç†æ•°æ®ï¼š${Thread.currentThread()}")
	            })
	            .observeOn(Schedulers.io())
	            .flatMap({
	                FLog.v("2è¯·æ±‚æ–‡ç« æ ‘æˆåŠŸï¼ŒIOçº¿ç¨‹ä¸­è·å–æ¥å£1çš„æ•°æ®ï¼Œç„¶åå°†è¢«è§‚å¯Ÿè€…å˜æ¢ä¸ºæ¥å£2çš„Observableï¼š${Thread.currentThread()}")
	                if(it?.errorCode == 0){
	                    //å½“treeidä¸ä¸ºnullæ‰§è¡Œ
	                    it?.data?.get(0)?.id?.let { it1 -> RetrofitClient.apiService.getArticleListByRx(0, it1) }
	                }else{
	                    //è¯·æ±‚é”™è¯¯çš„æƒ…å†µï¼Œå‘å°„ä¸€ä¸ªError
	                    Observable.error({
	                        Throwable("è·å–æ–‡ç« æ ‘å¤±è´¥ï¼š${it.errorCode}:${it.errorMsg}")
	                    })
	                }
	            })
	            .observeOn(AndroidSchedulers.mainThread())
	            .subscribe(object: Observer<ApiResult<Pagination<Article>>> {
	                override fun onComplete() {}
	                override fun onSubscribe(d: Disposable?) {}
	                override fun onNext(t: ApiResult<Pagination<Article>>?) {
	                    FLog.v("3è¯·æ±‚æ–‡ç« åˆ—è¡¨æˆåŠŸï¼š${t?.data}")
	                    responseBack(t?.data)
	                }
	                override fun onError(e: Throwable?) {
	                    FLog.e("3è¯·æ±‚å¤±è´¥ï¼š${e?.message}")
	                }
	            })
	}
}
```

Retrofit+RxJavaç¡®å®æ¶ˆé™¤äº†å›è°ƒçš„åµŒå¥—ï¼Œä½†æ˜¯è¿˜æ˜¯é¿å…ä¸äº†å›è°ƒï¼ˆObserverè§‚å¯Ÿè€…å¯çœ‹ä½œæ˜¯å›è°ƒï¼‰ï¼Œé“¾å¼è°ƒç”¨å¤„ç†å¼‚æ­¥æ•°æ®æµç¡®å®æ¯”ä¼ ç»Ÿçš„åµŒå¥—å›è°ƒå¥½äº†å¤ªå¤šï¼Œä½†æ˜¯ä»£ç é‡ä¸å‡åå¢ï¼Œè€Œä¸”æˆ‘ä»¬éœ€è¦åœ¨æ­£ç¡®çš„ä½ç½®å‡†ç¡®çš„æ’å…¥ä¸åŒçš„æ“ä½œç¬¦ç”¨æ¥å¤„ç†å¼‚æ­¥æ•°æ®ï¼Œå¯¹äºä¸ç†Ÿæ‚‰Rxçš„åŒå­¦æ¥è¯´ä¹Ÿæ˜¯å¾ˆå¤´ç—›çš„ã€‚**è™½ç„¶é“¾å¼çš„å¤„ç†å¼‚æ­¥æ•°æ®çœŸçš„å¾ˆä¼˜é›…ï¼ˆå ªç§°è‰ºæœ¯ï¼‰ï¼Œä½†æ˜¯å¯¹äºå¤§éƒ¨åˆ†ç¼–ç è€…æ¥è¯´å¯èƒ½ç§°ä¸ä¸Šç—›å¿«ã€‚**

**æ€æ ·æ‰ç—›å¿«ï¼Ÿæ€æ ·æ‰ç—›å¿«ï¼Ÿæ€æ ·æ‰ç—›å¿«ï¼Ÿ**

## 2.3 åŒæ­¥è°ƒç”¨

æˆ‘è°ƒç”¨æ¥å£æ–¹æ³•è¯·æ±‚æ•°æ®ï¼Œæ–¹æ³•ç›´æ¥ç»™æˆ‘è¿”å›æ•°æ®ï¼Œæˆ‘ä¸å…³å¿ƒçº¿ç¨‹åˆ‡æ¢ï¼Œæ‹¿åˆ°æ•°æ®å°±å±•ç¤ºï¼Œè¿™æ‰ç¬¦åˆå¸¸äººæ€ç»´ï¼Œæ‰ç—›å¿«ï¼š

```kotlin
/**
 * æ­¤å¤„è°ƒç”¨RetrofitClient.apiServiceçš„æ¥å£è¿”å›çš„æ˜¯Retrofitçš„Callå®ä¾‹ï¼Œè°ƒç”¨Call.execute()æ–¹æ³•åŒæ­¥è¯·æ±‚æ•°æ®
 */
fun getArticleList() {
    //åŒæ­¥è°ƒç”¨æ¥å£1ï¼Œç›´æ¥å¾—åˆ°è¿”å›æ•°æ®
    val response1 : Response<ApiResult<MutableList<Tree>>> = RetrofitClient.apiService.getTree().execute()
    val cid = response1.body()?.data?.get(0)?.id
    if(cid!=null){
        //åŒæ­¥è°ƒç”¨æ¥å£2ï¼Œç›´æ¥å¾—åˆ°è¿”å›æ•°æ®
        val response2 : Response<ApiResult<Pagination<Article>>> = RetrofitClient.apiService.getArticleList(0, cid).execute()
        page.value = response2.body()?.data!!
    }
}

/**æ¥å£å®šä¹‰*/
interface ApiService {
	companion object {
        const val BASE_URL = "https://www.wanandroid.com"
    }
    /*è·å–æ–‡ç« æ ‘ç»“æ„*/
    @GET("tree/json")
    fun getTree(): Call<ApiResult<MutableList<Tree>>>

    /*æ ¹æ®æ•°ç»“æ„ä¸‹æŸä¸ªåˆ†æ”¯idï¼Œè·å–åˆ†æ”¯ä¸‹çš„æ–‡ç« */
    @GET("article/list/{page}/json")
    fun getArticleList(
            @Path("page") page: Int,
            @Query("cid") cid: Int
    ): Call<ApiResult<Pagination<Article>>>
}
```

çœ‹çœ‹ä¸Šé¢çš„`getArticleList()`æ–¹æ³•ï¼Œä½¿ç”¨åŒæ­¥çš„æ–¹å¼è¯·æ±‚æ¥å£ï¼Œç›´æ¥æ‹¿åˆ°è¿”å›æ•°æ®ï¼Œçˆ½ä¸çˆ½ï¼Ÿå¾ˆçˆ½ï¼Œä½ ä»¬ä¸ªä¸ªéƒ½æ˜¯äººæ‰ï¼Œå¼‚æ­¥æ˜¯ä¸å¯èƒ½å¼‚æ­¥çš„ï¼Œçº¿ç¨‹åˆ‡æ¢åˆä¸ä¼šï¼Œåªæœ‰è¿™æ ·å†™æ‰èƒ½ç»´æŒå¾—äº†ç”Ÿæ´»çš„è¿™æ ·å­...ã€‚å¥½å§ï¼Œè¿è¡Œé¡¹ç›®ï¼šbong!!!

```xml
2021-03-05 13:43:07.078 12508-12508/com.openxu.android E/AndroidRuntime: FATAL EXCEPTION: main
    Process: com.openxu.android, PID: 12508
    java.lang.RuntimeException: Unable to resume activity {com.openxu.android/com.openxu.android.MainActivity}: android.os.NetworkOnMainThreadException
    ...
```

æˆ‘ç›¸ä¿¡è¿™ç§åŒæ­¥è°ƒç”¨çš„å†™æ³•å¯ä»¥è¯´æ˜¯æ‰€æœ‰å¼€å‘è€…æ¢¦å¯ä»¥æ±‚çš„ï¼Œç„¶è€ŒAndroidä¸å…è®¸åœ¨ä¸»çº¿ç¨‹ä¸­è€—æ—¶ç­‰å¾…ï¼Œæˆ‘ä»¬åªèƒ½å¿æ°”åå£°çš„å¤„ç†å„ç§å›è°ƒï¼Œkotlinåç¨‹åº“çš„å‡ºç°ç»ˆäºè®©å®ƒæˆä¸ºç°å®ã€‚

## 2.4 åç¨‹--ç”¨åŒæ­¥çš„æ–¹å¼ç¼–å†™å¼‚æ­¥ä»£ç 

ä»¥å¾€æˆ‘ä»¬ç¼–å†™å¼‚æ­¥ä»£ç ï¼Œéœ€è¦å…³æ³¨ï¼š

- å­çº¿ç¨‹ä»€ä¹ˆæ—¶å€™æ‰§è¡Œç»“æŸï¼Ÿå› ä¸ºç»“æŸä¹‹åéœ€è¦åœ¨å¯¹åº”çš„å›è°ƒä¸­è·å–æ•°æ®
- å­çº¿ç¨‹ä¸­çš„æ•°æ®æ€æ ·å‘é€åˆ°ä¸»çº¿ç¨‹ï¼Ÿç”¨ä¼ ç»ŸHandlerï¼Ÿè¿˜æ˜¯å„ç§äº‹ä»¶æ€»çº¿å¦‚EventBusï¼ŸLiveData(æŠ±æ­‰ï¼ŒLiveDataå¹¶ä¸æ”¯æŒçº¿ç¨‹åˆ‡æ¢ï¼Œåªèƒ½åœ¨UIçº¿ç¨‹ä¸­setValue)ï¼Ÿ
- å¤šä¸ªçº¿ç¨‹çš„ç®¡ç†é—®é¢˜

ä½¿ç”¨åç¨‹å°±å¯ä»¥è®©æˆ‘ä»¬æ‘†è„±å› ä¸ºå¤šçº¿ç¨‹å¸¦æ¥çš„å„ç§ç¼–ç ä¸Šçš„ä¸ä¾¿ï¼š

```kotlin
class SystemViewModel : BaseViewModel(){
    private val remoteRepository : SystemRemoteRepository by lazy { SystemRemoteRepository() }
    val page = MutableLiveData<Pagination<Article>>()

    fun getArticleList() {
        viewModelScope.launch {  //ä¸»çº¿ç¨‹å¼€å¯ä¸€ä¸ªåç¨‹
        	// ç½‘ç»œè¯·æ±‚ï¼šIOçº¿ç¨‹(éœ€è¦æ³¨æ„çš„æ˜¯OkHttpè¯·æ±‚çš„éƒ¨åˆ†æ˜¯å­çº¿ç¨‹ï¼ŒRetrofitéƒ¨åˆ†æ˜¯ä¸»çº¿ç¨‹ï¼Œè¿™éƒ¨åˆ†å†…å®¹è¯·çœ‹åç»­å…³äºæŒ‚èµ·å‡½æ•°çš„è®²è§£)
            val tree : ApiResult<MutableList<Tree>> = RetrofitClient.apiService.getTreeByCoroutines()
            // ä¸»çº¿ç¨‹
            val cid = tree?.data?.get(0)?.id
            if(cid!=null){
            	// ç½‘ç»œè¯·æ±‚ï¼šIOçº¿ç¨‹
                val pageResult : ApiResult<Pagination<Article>> = RetrofitClient.apiService.getArticleListByCoroutines(0, cid)
                // ä¸»çº¿ç¨‹
                page.value = pageResult.data!!
            }
        }
    }
}

/**æ¥å£å®šä¹‰ï¼ŒRetrofitä»2.6.0ç‰ˆæœ¬å¼€å§‹æ”¯æŒåç¨‹*/
interface ApiService {
	/*è·å–æ–‡ç« æ ‘ç»“æ„*/
	@GET("tree/json")
	suspend fun getTreeByCoroutines(): ApiResult<MutableList<Tree>>
	/*æ ¹æ®æ•°ç»“æ„ä¸‹æŸä¸ªåˆ†æ”¯idï¼Œè·å–åˆ†æ”¯ä¸‹çš„æ–‡ç« */
	@GET("article/list/{page}/json")
	suspend fun getArticleListByCoroutines(
	    @Path("page") page: Int,
	    @Query("cid") cid: Int
	): ApiResult<Pagination<Article>>
}
```

è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œå°½ç„¶æˆåŠŸäº†ï¼Œåˆšåˆšå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿè¿™ä¸å°±æ˜¯åŒæ­¥è°ƒç”¨å—ï¼Ÿè·Ÿä¸Šé¢çš„åŒæ­¥æœ‰ä»€ä¹ˆä¸ä¸€æ ·å—ï¼Ÿçœ‹èµ·æ¥å·®ä¸å¤šå•Šï¼Œç¡®å®å·®ä¸å¤šï¼Œå°±æ˜¯åœ¨å®šä¹‰æ¥å£æ—¶ï¼Œæ–¹æ³•å‰åŠ äº†ä¸ª`suspend`å…³é”®å­—ï¼Œè°ƒç”¨æ¥å£çš„æ—¶å€™ç”¨`viewModelScope.launch {}`åŒ…è£¹ã€‚æ—¢ç„¶å¯ä»¥è¿è¡ŒæˆåŠŸï¼Œå°±è¯´æ˜è¯·æ±‚æ¥å£å¹¶ä¸æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¿›è¡Œçš„ï¼Œç„¶è€Œæœ‰çš„åŒå­¦ä¸ä¿¡ï¼Œä»–åœ¨`getArticleList()`æ–¹æ³•ä¸­çš„ä»»æ„ä½ç½®é€šè¿‡`Thread.currentThread()`æ‰“å°çš„ç»“æœéƒ½æ˜¯`Thread[main,5,main]`ï¼Œè¿™ä¸å°±æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨çš„å—ï¼Ÿä¸Šè¿°åç¨‹ä¸­çš„ä»£ç æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œæ²¡é”™ï¼Œä½†æ˜¯æ¥å£è¯·æ±‚çš„æ–¹æ³•å´æ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œçš„ã€‚

åŸå› å°±åœ¨äºæˆ‘ä»¬å®šä¹‰æ¥å£çš„æ—¶å€™ä½¿ç”¨äº†`suspend`å…³é”®å­—ï¼Œå®ƒçš„æ„æ€æ˜¯æŒ‚èµ·ã€æš‚åœï¼Œå‡½æ•°è¢«åŠ äº†è¿™ä¸ªæ ‡è®°å°±ç§°å®ƒä¸ºæŒ‚èµ·å‡½æ•°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`suspend`å…³é”®å­—å¹¶æ²¡æœ‰å…¶ä»–é‡è¦çš„ä½œç”¨ï¼Œå®ƒä»…ä»…æ ‡è¯†æŸä¸ªå‡½æ•°æ˜¯æŒ‚èµ·å‡½æ•°ï¼Œå¯ä»¥åœ¨å‡½æ•°ä¸­è°ƒç”¨å…¶ä»–æŒ‚èµ·å‡½æ•°ï¼Œä½†æ˜¯åªèƒ½åœ¨åç¨‹ä¸­è°ƒç”¨å®ƒã€‚æ‰€ä»¥ä¸Šé¢ä¸¤ä¸ªæ¥å£éƒ½è¢«å®šä¹‰ä¸ºæŒ‚èµ·å‡½æ•°äº†ï¼ŒæŒ‚èµ·å‡½æ•°åªèƒ½åœ¨åç¨‹ä¸­è°ƒç”¨ï¼Œé‚£è°æ˜¯åç¨‹ï¼Ÿ

å…¶å®åœ¨kotlinåç¨‹åº“ä¸­æ˜¯æœ‰ä¸€ä¸ªç±»`AbstractCoroutine`æ¥è¡¨ç¤ºåç¨‹çš„ï¼Œè¿™ä¸ªæŠ½è±¡ç±»æœ‰å¾ˆå¤šå­ç±»ä»£è¡¨ä¸åŒçš„åç¨‹ï¼Œä½†æ˜¯è¿™äº›å­ç±»éƒ½æ˜¯privateçš„ï¼Œå¹¶æ²¡æœ‰æš´éœ²ç»™æˆ‘ä»¬ï¼Œæ‰€ä»¥ä½ åœ¨å…¶ä»–æ–‡ç« ä¸­çœ‹åˆ°åˆ«äººè¯´`viewModelScope.launch{}`åŒ…è£¹èµ·æ¥çš„é—­åŒ…(ä»£ç å—)å°±æ˜¯åç¨‹ä¹Ÿæ²¡é—®é¢˜ï¼Œä½†è¿™ä¸ªä»£ç å—çš„çœŸæ­£æ„ä¹‰æ˜¯åç¨‹éœ€è¦æ‰§è¡Œçš„ä»£ç ã€‚å½“åœ¨åç¨‹ä¸­è°ƒç”¨åˆ°æŒ‚èµ·å‡½æ•°æ—¶ï¼Œåç¨‹å°±ä¼šåœ¨å½“å‰çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ä¸­è¢«æŒ‚èµ·ï¼Œè¿™å°±æ˜¯åç¨‹ä¸­è‘—åçš„**éé˜»å¡å¼æŒ‚èµ·**ï¼Œä¸»çº¿ç¨‹æš‚æ—¶åœæ­¢æ‰§è¡Œè¿™ä¸ªåç¨‹ä¸­å‰©ä½™çš„ä»£ç ï¼Œæ³¨æ„ï¼šæš‚åœå¹¶ä¸æ˜¯é˜»å¡ç­‰å¾…ï¼ˆå¦åˆ™ä¼šANRï¼‰ï¼Œè€Œæ˜¯**ä¸»çº¿ç¨‹æš‚æ—¶ä»è¿™ä¸ªåç¨‹ä¸­è¢«é‡Šæ”¾å‡ºæ¥å»å¤„ç†å…¶ä»–Handleræ¶ˆæ¯**ï¼Œæ¯”å¦‚å“åº”ç”¨æˆ·æ“ä½œã€ç»˜åˆ¶Viewç­‰ç­‰ã€‚

é‚£æŒ‚èµ·å‡½æ•°è°æ‰§è¡Œï¼Ÿè¿™å¾—çœ‹æŒ‚èµ·å‡½æ•°å†…éƒ¨æ˜¯å¦æœ‰åˆ‡æ¢çº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰åˆ‡æ¢çº¿ç¨‹å½“ç„¶å°±æ˜¯ä¸»çº¿ç¨‹æ‰§è¡Œäº†ï¼Œæ‰€ä»¥**æŒ‚èµ·å‡½æ•°ä¸ä¸€å®šå°±æ˜¯åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œçš„**ï¼Œä½†æ˜¯é€šå¸¸åœ¨å®šä¹‰æŒ‚èµ·å‡½æ•°æ—¶éƒ½ä¼šä¸ºå®ƒæŒ‡å®šå…¶ä»–çº¿ç¨‹ï¼Œè¿™æ ·æŒ‚èµ·æ‰æœ‰æ„ä¹‰ã€‚æ¯”å¦‚ä¸Šé¢å®šä¹‰çš„suspendçš„è¯·æ±‚æ¥å£ï¼ŒRetoriftåœ¨æ‰§è¡Œè¯·æ±‚çš„æ—¶å€™å°±åˆ‡æ¢åˆ°äº†å­çº¿ç¨‹å¹¶æŒ‚èµ·ä¸»çº¿ç¨‹ï¼Œå½“è¯·æ±‚å®Œæˆï¼ˆæŒ‚èµ·å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼‰è¿”å›ç»“æœæ—¶ï¼Œä¼šé€šçŸ¥ä¸»çº¿ç¨‹ï¼šæˆ‘è¯¥å¹²çš„éƒ½å¹²å®Œäº†ï¼Œä¸‹é¢çš„äº‹ä½ æ¥ç€å¹²å§ï¼Œä¸»çº¿ç¨‹æ¥åˆ°é€šçŸ¥åå°±ä¼šæ‹¿åˆ°æŒ‚èµ·å‡½æ•°è¿”å›çš„ç»“æœç»§ç»­æ‰§è¡Œåç¨‹é‡Œé¢å‰©ä½™çš„ä»£ç ï¼Œè¿™å«åš**åç¨‹æ¢å¤(resume)**ã€‚å¦‚æœåˆé‡åˆ°æŒ‚èµ·å‡½æ•°å°±ä¼šé‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ°åç¨‹ä¸­çš„ä»£ç è¢«æ‰§è¡Œå®Œã€‚

é€šè¿‡åç¨‹å¯ä»¥å½»åº•å»é™¤å›è°ƒï¼Œ**ä½¿ç”¨åŒæ­¥çš„æ–¹å¼ç¼–å†™å¼‚æ­¥ä»£ç **ã€‚ä»€ä¹ˆæ˜¯åŒæ­¥è°ƒç”¨ï¼Ÿè°ƒç”¨ä¸€ä¸ªæ–¹æ³•èƒ½ç›´æ¥æ‹¿åˆ°æ–¹æ³•çš„è¿”å›å€¼ï¼Œå°½ç®¡è¿™ä¸ªæ–¹æ³•æ˜¯è€—æ—¶çš„ã€åœ¨å…¶ä»–çº¿ç¨‹æ‰§è¡Œçš„ï¼Œä¹Ÿèƒ½ç›´æ¥å¾—åˆ°å®ƒçš„è¿”å›å€¼ï¼Œç„¶åå†æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼Œåç¨‹ä¸æ˜¯é€šè¿‡ç­‰å¾…çš„æ–¹å¼å®ç°åŒæ­¥ï¼Œè€Œæ˜¯é€šè¿‡éé˜»å¡æŒ‚èµ·å®ç°çœ‹èµ·æ¥åŒæ­¥çš„æ•ˆæœã€‚

## 2.5 åç¨‹åªæ˜¯ä¸ºäº†æ¶ˆç­å›è°ƒï¼Ÿ

åç¨‹çˆ½å—ï¼Ÿå¾ˆçˆ½ï¼Œä½†æ˜¯åç¨‹å°±æ˜¯ä¸ºäº†è§£å†³åµŒå¥—å›è°ƒå—ï¼Ÿå¹¶éå¦‚æ­¤ï¼Œæ¶ˆç­å›è°ƒåªæ˜¯åˆ©ç”¨åç¨‹å®ç°çš„ä¸€ä¸ªå¾ˆå°çš„éƒ¨åˆ† ã€‚å…¶å®ä¸Šé¢ç¬¬ä¸€éƒ¨åˆ†è®²åç¨‹æ˜¯ä»€ä¹ˆçš„æ—¶å€™å°±å·²ç»è¯´äº†ï¼Œåç¨‹æ˜¯ä¸ºäº†è®©æˆ‘ä»¬**æ›´æ–¹ä¾¿çš„å†™å¹¶å‘ä»£ç ï¼ŒæŠŠåŸæœ¬è¿è¡Œåœ¨ä¸åŒçº¿ç¨‹çš„ä»£ç å†™åœ¨ä¸€ä¸ªä»£ç å—{}é‡Œï¼Œçœ‹èµ·æ¥å°±åƒæ˜¯åŒæ­¥ä»£ç ã€‚**ï¼Œå®ƒçš„ä¾§é‡ç‚¹æ˜¯**å¤šçº¿ç¨‹å¹¶å‘**å’Œ**çœ‹èµ·æ¥åŒæ­¥**ã€‚æ‰€ä»¥å¯¹äºä¸²è¡Œï¼ˆä¸Šè¿°åµŒå¥—ï¼‰æˆ–è€…å¹¶è¡Œï¼ˆå¤šä¸ªæ¥å£å¹¶è¡Œè¯·æ±‚ï¼‰çš„ä»£ç éƒ½å¯ä»¥ç”¨åç¨‹æ¥"åŒæ­¥"è°ƒç”¨çš„ï¼Œ**ä¸ç®¡ä¸šåŠ¡æœ‰å¤šå¤æ‚ï¼Œéƒ½å¯ä»¥ç”¨åç¨‹å†™å‡ºæ¸…æ™°çš„ä¸Šä¸‹è¡Œä»£ç ç»“æ„**ã€‚


# 3. kotlinåç¨‹å‡ºç°çš„åŸå› 

ä¸Šé¢çš„ç¤ºä¾‹æ¼”ç¤ºäº†ä½¿ç”¨åç¨‹è§£å†³å›è°ƒåœ°ç‹±ã€è‡ªç”±åˆ‡æ¢çº¿ç¨‹ã€å¤§å¤§å‡å°‘ä»£ç é‡ç­‰ä¼˜åŠ¿ï¼Œåç¨‹ä½¿ç”¨èµ·æ¥çœŸçš„å¾ˆçˆ½ï¼Œè¿™äº›éƒ½æ˜¯ä½“ç°åœ¨ä½¿ç”¨å±‚é¢çš„ã€‚ä½†æ˜¯kotlinåç¨‹æ²¡æœ‰å‡ºç°æ—¶ï¼Œä»£ç ä¹Ÿç…§æ ·èƒ½è·‘çš„å•Šï¼Œä¸ºä»€ä¹ˆkotlinéå¾—æåç¨‹å‡ºæ¥å‘¢ï¼Ÿå°±æ˜¯ä¸ºäº†å¢å¼ºæˆ‘ä»¬ï¼šgoogleçˆ¸çˆ¸ï¼Œæˆ‘ä»¬å­¦ä¸åŠ¨äº† çš„æ„Ÿè§‰å—ï¼Ÿå¾ˆæ˜¾ç„¶è¿™ä¸æ˜¯æœ¬æ„ï¼Œkotlinç›¸å¯¹äºjavaçš„ä¸€æ–¹é¢ä¼˜åŠ¿å°±æ˜¯ç®€æ´ï¼Œè€Œå„ç§å›è°ƒåµŒå¥—æ˜¾ç„¶æ˜¯kotlinä¸èƒ½å®¹å¿çš„ï¼Œå†è€…kotlinæ”¯æŒé«˜é˜¶å‡½æ•°è¿™å°±ä¸ºkotlinåç¨‹è®¾è®¡å¸¦æ¥äº†ä¾¿åˆ©ï¼Œæœ‰äº†è¿™äº›åŸç”±æ”¯æ’‘ï¼Œkotlinåç¨‹å°±è¯ç”Ÿäº†ã€‚

æ¦‚æ‹¬èµ·æ¥å…¶å®å°±æ˜¯ä½¿ç”¨kotlinåç¨‹è®©ä»£ç æ›´ç®€æ´ã€‚æ ¹æœ¬åŸå› æ˜¯**è§£å†³äº†å¼‚æ­¥ä»»åŠ¡éé˜»å¡åŒæ­¥è¿”å›æ•°æ®çš„é—®é¢˜ï¼Œè¾¾åˆ°ç®€åŒ–ä»£ç é€»è¾‘ã€æ‰€è§å³æ‰€å¾—çš„ç›®çš„**ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å…ˆææ‡‚ä»€ä¹ˆæ˜¯å¼‚æ­¥ä»»åŠ¡ã€ä»¥åŠå¼‚æ­¥ä»»åŠ¡æ•°æ®è¿”å›

**å¼‚æ­¥è®¡ç®—**ï¼šè¿™ä¸ªä¸ç”¨åšå¤šä»‹ç»äº†å§ï¼Œå¼‚æ­¥æ˜¯å¤šçº¿ç¨‹çš„æ¦‚å¿µï¼Œè¯´ç®€å•ç‚¹å°±æ˜¯å°†ä¸€éƒ¨åˆ†è®¡ç®—æ”¾åˆ°å¦å¤–çš„çº¿ç¨‹æ‰§è¡Œã€‚æ¯”å¦‚Androidä¸­ä¸»çº¿ç¨‹(UIçº¿ç¨‹)æ˜¯ä¸ºäº†å“åº”ç»˜åˆ¶ã€ç”¨æˆ·äº¤äº’çš„ï¼Œå¦‚æœä¸€äº›è€—æ—¶ä»»åŠ¡(ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æ“ä½œç­‰)è®©ä¸»çº¿ç¨‹æ‰§è¡Œå°±ä¼šé€ æˆUIå¡é¡¿ï¼Œæ‰€ä»¥å°†è¿™äº›è€—æ—¶æ“ä½œæ”¾åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œï¼Œç›¸å¯¹äºä¸»çº¿ç¨‹æ¥è¯´ï¼Œè¿™äº›è€—æ—¶ä»»åŠ¡å°±æ˜¯å¼‚æ­¥è®¡ç®—çš„ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡(ä¸€ä¸ªæ–¹æ³•)æ˜¯ä¸ºäº†è·å–ä¸€ä¸ªè®¡ç®—ç»“æœï¼Œå¼‚æ­¥è®¡ç®—æ˜¯æ€ä¹ˆè¿”å›ç»“æœæ•°æ®çš„å‘¢ï¼Ÿæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š

## 3.1 CallBackå¼‚æ­¥å›è°ƒ

```koltin
/**è€—æ—¶è·å–ä¸€ä¸ªæ•´æ•°çš„å¹³æ–¹å€¼*/
fun square(input:Int):Int{
    println("è€—æ—¶ä»»åŠ¡åœ¨å­çº¿ç¨‹ ${Thread.currentThread()}")
    Thread.sleep(2000)
    return input * input
}

//æ¨¡æ‹Ÿä¸€ä¸ªè€—æ—¶çš„å¼‚æ­¥ï¼ˆå­çº¿ç¨‹ï¼‰ä»»åŠ¡ï¼Œé€šè¿‡å›è°ƒè·å–ç»“æœ
fun asynCallBack(onComplete : (result:Int)->Unit){
    Thread {
        val result = square(10)
        onComplete(result)
    }.start()
}
fun main() {
    println("ä¸»çº¿ç¨‹ï¼š${Thread.currentThread()}")
    //è°ƒç”¨å¼‚æ­¥è®¡ç®—æ–¹æ³•ï¼Œä¼ å…¥å›è°ƒå‡½æ•°è·å–è®¡ç®—ç»“æœ
    asynCallBack (onComplete = {
        println("${Thread.currentThread()}å¼‚æ­¥è€—æ—¶ä»»åŠ¡è®¡ç®—ç»“æœ $it")
    })

    Thread.sleep(5000)  //ä¸»çº¿ç¨‹ä¼‘çœ 5sé¿å…jvmé€€å‡º
}
```

æ‰§è¡Œç»“æœï¼š

```xml
ä¸»çº¿ç¨‹ï¼šThread[main,5,main]
è€—æ—¶ä»»åŠ¡åœ¨å­çº¿ç¨‹ï¼šThread[Thread-0,5,main]
Thread[Thread-0,5,main]å¼‚æ­¥è€—æ—¶ä»»åŠ¡è®¡ç®—ç»“æœ 100

Process finished with exit code 0
```

ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œmainå‡½æ•°æ‰€åœ¨çº¿ç¨‹æ˜¯ä¸ä¼šç­‰å¾…å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œå®Œæˆçš„ï¼Œå®ƒæ‰€åšçš„å°±æ˜¯è°ƒç”¨äº†asynCallBackè¿™ä¸ªå‡½æ•°ï¼Œå¹¶åœ¨è¿™ä¸ªå‡½æ•°ä¸­å¼€å¯äº†ä¸€ä¸ªå­çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹çš„ä»»åŠ¡å°±å®Œæˆäº†ï¼Œå¦‚æœä¸é€šè¿‡`Thread.sleep(5000)`è®©ä¸»çº¿ç¨‹ä¼‘çœ ï¼Œæ˜¯ä¸ä¼šè§‚å¯Ÿåˆ°ä»»ä½•ç»“æœçš„ï¼Œå› ä¸ºä¸»çº¿ç¨‹æ‰§è¡Œå®Œjvmå°±é€€å‡ºäº†ã€‚

è¿™ä¸ªç¤ºä¾‹å°±å±•ç¤ºäº†å¼‚æ­¥ä»»åŠ¡é€šè¿‡å›è°ƒçš„æ–¹å¼è·å–è®¡ç®—ç»“æœï¼Œå¼‚æ­¥è®¡ç®—çš„ç»“æœå¹¶æ²¡æœ‰è¿”å›åˆ°ä¸»çº¿ç¨‹ä¸­ï¼Œå¦‚æœæ˜¯åœ¨Androidä¸­ï¼Œé€šå¸¸éœ€è¦ä½¿ç”¨`Activity.runOnUiThread()`å°†ç»“æœè½¬ç§»å›UIçº¿ç¨‹å±•ç¤ºã€‚

## 3.2 Futureé˜»å¡è·å–å¼‚æ­¥è®¡ç®—ç»“æœ

ä¸¥æ ¼çš„è¯´æ¥ï¼Œé€šè¿‡å›è°ƒçš„æ–¹å¼å¹¶ä¸èƒ½çœ‹ä½œæ˜¯å¼‚æ­¥è®¡ç®—è¿”å›æ‰§è¡Œç»“æœï¼Œå› ä¸ºè¿”å›ç»“æœé€šå¸¸çœ‹èµ·æ¥æ˜¯`val result = asynCallBack()`è¿™æ ·çš„ï¼Œä½†æ˜¯Javaä¸­é€šè¿‡Threadæ²¡æœ‰åŠæ³•è·å–å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œåœ¨JDK5ä¸­å¼•å…¥äº†`Future`ï¼ŒFutureè¡¨ç¤ºå¼‚æ­¥è®¡ç®—çš„ç»“æœï¼Œæä¾›äº†`cancel()`å–æ¶ˆä»»åŠ¡ã€`get()`é˜»å¡ç­‰å¾…è·å–ç»“æœç­‰æ–¹æ³•ï¼Œç›¸ä¿¡å¾ˆå¤šäººå¯¹å®ƒéƒ½ä¸äº†è§£ï¼Œå› ä¸ºåœ¨Androidå¼€å‘ä¸­åŸºæœ¬ä¸ä¼šæ¥è§¦åˆ°è¿™ä¸ªç±»ï¼Œå› ä¸ºå®ƒæ˜¯çº¿ç¨‹é˜»å¡çš„ã€‚ä¸‹é¢ä½¿ç”¨Futureæ”¹å†™ç¤ºä¾‹ï¼š

```kotlin
fun asynFuture() : Future<Int> {
    //å°†ä¸€ä¸ªCallableå¯¹è±¡æäº¤åˆ°çº¿ç¨‹æ± ä¸­ï¼Œè¿”å›ä¸€ä¸ªFutureå¯¹è±¡è¡¨ç¤ºå¼‚æ­¥è®¡ç®—ç»“æœ
    return Executors.newSingleThreadExecutor()
            .submit(Callable<Int> {
                square(10)
            })
}
fun main() {
    println("ä¸»çº¿ç¨‹ï¼š${Thread.currentThread()}")
    val future = asynFuture()
    //é˜»å¡ç­‰å¾…è·å–å¼‚æ­¥è®¡ç®—ç»“æœ
    val result = future.get()
    //å¼‚æ­¥è®¡ç®—æ‰§è¡Œå®Œæ¯•æ‰ä¼šæ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼Œä¸»çº¿ç¨‹å°±åƒæ˜¯è¢«é˜»å¡åŠ«æŒäº†
    println("é˜»å¡ä¸»çº¿ç¨‹ç­‰å¾…å¼‚æ­¥è®¡ç®—æ‰§è¡Œç»“æœï¼š$result")
}
```

æ‰§è¡Œç»“æœï¼š

```kotlin
ä¸»çº¿ç¨‹ï¼šThread[main,5,main]
è€—æ—¶ä»»åŠ¡åœ¨å­çº¿ç¨‹ï¼šThread[pool-1-thread-1,5,main]
é˜»å¡ä¸»çº¿ç¨‹ç­‰å¾…å¼‚æ­¥è®¡ç®—æ‰§è¡Œç»“æœï¼š100
```

Futureé€šå¸¸ç”¨äºè®¡ç®—å¯†é›†ã€å¤„ç†å¤§é‡æ•°æ®ç­‰åœºæ™¯ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡å®ƒè·å–å¼‚æ­¥è®¡ç®—çš„ç»“æœï¼Œè¿™è·Ÿkotlinåç¨‹çœ‹èµ·æ¥å·®ä¸å¤šäº†ï¼Œæœ€å…³é”®çš„åŒºåˆ«æ˜¯å®ƒæ˜¯çº¿ç¨‹é˜»å¡ç­‰å¾…çš„ï¼Œå¦‚æœæ˜¯åœ¨UIåº”ç”¨ç¨‹åº(æ¯”å¦‚Android)ä¸­ï¼Œé˜»å¡UIçº¿ç¨‹çº¿ç¨‹æ˜¯ä¸è¢«å…è®¸çš„ï¼Œæ‰€ä»¥Futureå¯¹äºæˆ‘ä»¬æ¥è¯´å¹¶ä¸å¸¸ç”¨

## 3.3 åç¨‹éé˜»å¡æŒ‚èµ·

```kotlin
suspend fun asynCoroutine() : Int = withContext(Dispatchers.IO){
    square(10)
}

override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    println("ä¸»çº¿ç¨‹ï¼š${Thread.currentThread()}")
    //å¼€å¯åç¨‹ï¼Œå°†å¼‚æ­¥è€—æ—¶ä»»åŠ¡åŒ…è£¹åœ¨åç¨‹æ‰§è¡Œä½“ä»£ç å—ä¸­
    CoroutineScope(Dispatchers.Main).launch{
        // 1. å¼‚æ­¥æ‰§è¡ŒæŒ‚èµ·ï¼ŒæŒ‚èµ·æ˜¯éé˜»å¡çš„ï¼Œä¼šé‡Šæ”¾ä¸»çº¿ç¨‹å»åšåˆ«çš„äº‹æƒ…
        val result = asynCoroutine()
        // 2. å¼‚æ­¥æ‰§è¡Œå®Œç»§ç»­æ‰§è¡Œï¼Œæ›´æ–°UI
        tvResult.text = "å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œç»“æœï¼š$result"
    }
}
```

è¿™ä¸ªç¤ºä¾‹æ˜¯åœ¨Android Activityç¯å¢ƒä¸­ï¼Œè¿™æ ·æ›´å¥½çš„ç†è§£æŒ‚èµ·å‡½æ•°çš„éé˜»å¡æŒ‚èµ·ã€‚`asynCoroutine()`æ˜¯ä¸€ä¸ªæŒ‚èµ·å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°†åœ¨å­çº¿ç¨‹ä¸­è¢«è°ƒåº¦ï¼Œåœ¨UIçº¿ç¨‹ä¸­å¼€å¯ä¸€ä¸ªåç¨‹ï¼Œå¹¶åœ¨åç¨‹ä»£ç å—ä¸­è°ƒç”¨æŒ‚èµ·å‡½æ•°(æ³¨é‡Š1)ï¼ŒæŒ‚èµ·å‡½æ•°ä¹‹åçš„ä»£ç å°†åœæ­¢æ‰§è¡Œï¼Œç›´åˆ°æŒ‚èµ·å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œè¿™çœ‹èµ·æ¥å°±åƒæ˜¯åœ¨é˜»å¡ç­‰å¾…æŒ‚èµ·å‡½æ•°æ‰§è¡Œç»“æœï¼Œä½†æ˜¯å¹¶æ²¡æœ‰é˜»å¡ä¸»çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹è™½ç„¶æ²¡æœ‰ç»§ç»­æ‰§è¡ŒæŒ‚èµ·å‡½æ•°ä¹‹åçš„ä»£ç ï¼Œä½†æ˜¯å»å¹²äº†åˆ«çš„äº‹æƒ…ï¼ˆæ¯”å¦‚ç»˜åˆ¶UIã€å“åº”ç”¨æˆ·äº¤äº’ï¼‰ã€‚è°ƒç”¨æŒ‚èµ·å‡½æ•°å°±åƒæ˜¯åœ¨è°ƒç”¨å¤„æ‰“äº†ä¸ªæ ‡è®°ï¼Œå‘Šè¯‰ä¸»çº¿ç¨‹æˆ‘è¦å»å¹²ä¸€ä»¶å¤§äº‹å¯èƒ½è¦å¾ˆé•¿æ—¶é—´ï¼Œä½ å…ˆå»å¿™åˆ«çš„äº‹æƒ…å§ï¼Œæˆ‘æ‰§è¡Œå®Œå†é€šçŸ¥ä½ ã€‚å½“æŒ‚èµ·å‡½æ•°æ‰§è¡Œå®Œï¼Œå°±ä¼šæ‹¿ç€æ‰§è¡Œç»“æœé€šçŸ¥ä¸»çº¿ç¨‹æ¢å¤ç»§ç»­æ‰§è¡Œæ ‡è®°ç‚¹ä¹‹åçš„ä»£ç ã€‚è¿™å°±æ˜¯åç¨‹çš„éé˜»å¡æŒ‚èµ·ï¼Œä¹Ÿå°±æ˜¯è¯´åç¨‹å¯ä»¥**å®ç°éé˜»å¡è·å–å¼‚æ­¥è®¡ç®—ç»“æœ**ï¼Œè¿™å¯¹äºå„ç§UIç¯å¢ƒå¼€å‘æ¥è¯´ç®€ç›´æ˜¯å¤ªå¥½ç”¨äº†ï¼Œå› ä¸ºå¯ä»¥**ç”¨çœ‹èµ·æ¥åŒæ­¥çš„æ–¹å¼ç¼–å†™å¼‚æ­¥ä»£ç **


# 4. æ€»ç»“

è¿™ç¯‡æ–‡ç« åªæ˜¯å¸¦å¤§å®¶åˆæ­¥è®¤è¯†äº†åç¨‹ï¼Œç®€å•äº†è§£kotlinåç¨‹çš„æ¥ç”±ä»¥åŠå…¶ä¼˜åŠ¿ï¼Œå…³äºåç¨‹çš„ä½¿ç”¨å’Œå…¶åŸç†è¯·çœ‹æ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« ï¼Œå–œæ¬¢çš„æœ‹å‹åŠ ä¸ªå…³æ³¨ç‚¹ä¸ªèµï¼Œä¸€é”®ä¸‰è”æ¯”ä¸ªå¿ƒğŸ¤








## suspend
## å–æ¶ˆä¸è¶…æ—¶
## ç»„åˆæŒ‚èµ·å‡½æ•°
## åç¨‹ä¸Šä¸‹æ–‡ä¸è°ƒåº¦å™¨
## å¼‚æ­¥æµ
## é€šé“
## å¼‚å¸¸å¤„ç†ä¸ç›‘ç£
## å…±äº«çš„å¯å˜çŠ¶æ€ä¸å¹¶å‘
## Selectè¡¨è¾¾æ—¶

okhttp+åç¨‹ï¼Œæ‹¦æˆªå™¨æŠ›å‡ºçš„å¼‚å¸¸æ— æ³•æ•è·çš„é—®é¢˜

https://stackoverflow.com/questions/58697459/handle-exceptions-thrown-by-a-custom-okhttp-interceptor-in-kotlin-coroutines

okhttpä¸¤ç§æ·»åŠ æ‹¦æˆªå™¨æ–¹æ³•çš„åŒºåˆ«

//    Okhttp çš„addInterceptor å’Œ addNetworkInterceptor çš„åŒºåˆ«ï¼Ÿ
//    addInterceptorï¼ˆåº”ç”¨æ‹¦æˆªå™¨ï¼‰ï¼š
//    1ï¼Œä¸éœ€è¦æ‹…å¿ƒä¸­é—´è¿‡ç¨‹çš„å“åº”,å¦‚é‡å®šå‘å’Œé‡è¯•.
//    2ï¼Œæ€»æ˜¯åªè°ƒç”¨ä¸€æ¬¡,å³ä½¿HTTPå“åº”æ˜¯ä»ç¼“å­˜ä¸­è·å–.
//    3ï¼Œè§‚å¯Ÿåº”ç”¨ç¨‹åºçš„åˆè¡·. ä¸å…³å¿ƒOkHttpæ³¨å…¥çš„å¤´ä¿¡æ¯å¦‚: If-None-Match.
//    4ï¼Œå…è®¸çŸ­è·¯è€Œä¸è°ƒç”¨ Chain.proceed(),å³ä¸­æ­¢è°ƒç”¨.
//    5ï¼Œå…è®¸é‡è¯•,ä½¿ Chain.proceed()è°ƒç”¨å¤šæ¬¡.
//    addNetworkInterceptorï¼ˆç½‘ç»œæ‹¦æˆªå™¨ï¼‰ï¼š
//    1ï¼Œèƒ½å¤Ÿæ“ä½œä¸­é—´è¿‡ç¨‹çš„å“åº”,å¦‚é‡å®šå‘å’Œé‡è¯•.
//    2ï¼Œå½“ç½‘ç»œçŸ­è·¯è€Œè¿”å›ç¼“å­˜å“åº”æ—¶ä¸è¢«è°ƒç”¨.
//    3ï¼Œåªè§‚å¯Ÿåœ¨ç½‘ç»œä¸Šä¼ è¾“çš„æ•°æ®.
//    4ï¼Œæºå¸¦è¯·æ±‚æ¥è®¿é—®è¿æ¥.













