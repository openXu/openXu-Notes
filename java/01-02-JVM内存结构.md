
# JVM内存结构



公有指的是所有线程都共享的部分，指的是Java堆、方法区、常量池。
私有指的是每个线程的私有数据，包括：PC寄存器、Java 虚拟机栈、本地方法栈。

jvm内存结构包含以下内容：

## 公有部分（堆、方法区、常量池）

**堆**：Java堆内存是jvm内存中空间最大的一块内存，主要存储Java实例对象。也是gc主要光顾的地方。根据对象存活时间不同，Java堆还被分为年轻代、老年代两个区域，年轻代还被进一步划分为Eden区、From Survivor 0、To Survivor1区（Survivor：幸存者）。可设置新生代和老年代的相对大小，参数 -XX:NewRatio 设置老年代与新生代的比例。例如`-XX:NewRatio=8`指定老年代/新生代为8/1. 老年代占堆大小的7/8 ，新生代占1/8 .(默认即使1/8)。

对象永远优先被分配在年轻代的Eden区，除非对象过大超过阈值`-XX:PretenureSizeThresold`会直接分配在老年代中，等到Eden区域内存不够时，Java虚拟机会启动垃圾回收。此时Eden区中没有被引用的对象的内存就会被回收，没有被回收的对象会移动到Survivor区，当经过一定次数的GC还没有被回收的对象则会进入到老年代。在 JVM 中有一个名为`-XX:MaxTenuringThreshold=15`的参数专门用来设置晋升到老年代所需要经历的GC次数，即在年轻代的对象经过了指定次数的 GC后，将在下次GC时进入老年代。

因为存活时间短的对象有很多，那么势必导致较为频繁的垃圾回收。而垃圾回收时不得不对所有内存都进行扫描，但其实有一部分对象，它们存活时间很长，对他们进行扫描完全是浪费时间。因此为了提高垃圾回收效率，分区就理所当然了。

**方法区和常量池**：存储Class字节码数据的一块区域，它存储了每一个类的结构信息，例如运行时常量池、字段和方法数据、构造方法等。可以看到常量池其实是存放在方法区中的，但《Java 虚拟机规范》将常量池和方法区放在同一个等级上，这点我们知晓即可。

运行时常量池也在方法区中，用于存放Class文件中的字段，方法，接口和常量池等信息内容。

## 私有部分：PC寄存器、Java 虚拟机栈、本地方法栈

**程序计数器**：较小的内存空间，可以当成是当前线程执行的字节码的行号指示器，也就是根据这个程序计数器来决定下一步要执行啥！线程私有！在多线程中CPU切换线程怎么知道应该执行线程A中的哪一步，也就是说，之前在线程A中执行到哪了，这就要靠程序计数器去记录了。

**java虚拟机栈**：栈内存，与线程同时创建，用来存储栈帧，当线程中执行一个方法，会将方法入栈，方法中的局部变量表就会存储在栈帧中的局部变量表中

**本地方法栈**：与java虚拟机栈非常相似，有的虚拟机就把本地方法栈和java虚拟机栈合二为一，比如Sun HotSpot虚拟机！

