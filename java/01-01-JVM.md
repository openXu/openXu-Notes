
https://www.cnblogs.com/chanshuyi/p/jvm_serial_00_why_learn_jvm.html

# 概念

Java虚拟机与Java语言没有直接关系，它只按照 Java 虚拟机规范去读取 Class 文件，并按照规定去解析、执行字节码指令。Java虚拟机是一个字节码文件(Class文件)翻译器，它将字节码文件翻译成各个系统对应的机器码，确保字节码文件能在各个系统正确运行。

# Java编译字节码

对于 Java 虚拟机来说，其实际输入的是字节码文件，而不是 Java 文件。那么对于 Java 语言而言，其实怎么将 Java 代码转化成字节码文件的呢？我们知道在 JDK 的安装目录里有一个 javac 工具，就是它将 Java 代码翻译成字节码（十六进制的文件），这个工具我们叫做编译器。相对于后面要讲的其他编译器，其因为处于编译的前期，因此又被成为前端编译器。

其实就是使用 javac 编译器把 Java 语言规范转化为字节码语言规范。javac 编译器的处理过程可以分为下面四个阶段：

第一个阶段：词法、语法分析。在这个阶段，JVM 会对源代码的字符进行一次扫描，最终生成一个抽象的语法树。简单地说，在这个阶段 JVM 会搞懂我们的代码到底想要干嘛。就像我们分析一个句子一样，我们会对句子划分主谓宾，弄清楚这个句子要表达的意思一样。

第二个阶段：填充符号表。我们知道类之间是会互相引用的，但在编译阶段，我们无法确定其具体的地址，所以我们会使用一个符号来替代。在这个阶段做的就是类似的事情，即对抽象的类或接口进行符号填充。等到类加载阶段，JVM 会将符号替换成具体的内存地址。

第三个阶段：注解处理。我们知道 Java 是支持注解的，因此在这个阶段会对注解进行分析，根据注解的作用将其还原成具体的指令集。

第四个阶段：分析与字节码生成。到了这个阶段，JVM 便会根据上面几个阶段分析出来的结果，进行字节码的生成，最终输出为 class 文件。


# JVM内存结构

公有指的是所有线程都共享的部分，指的是 Java 堆、方法区、常量池。私有指的是每个线程的私有数据，包括：PC寄存器、Java 虚拟机栈、本地方法栈。

jvm内存结构包含以下内容：

## 公有部分（堆、方法区、常量池）

**堆**：Java堆内存是jvm内存中空间最大的一块内存，主要存储Java实例对象。也是gc主要光顾的地方。根据对象存活时间不同，Java堆还被分为年轻代、老年代两个区域，年轻代还被进一步划分为Eden区、From Survivor 0、To Survivor 1区。对象永远优先被分配在年轻代的 Eden 区，等到 Eden 区域内存不够时，Java 虚拟机会启动垃圾回收。此时 Eden 区中没有被引用的对象的内存就会被回收，而一些存活时间较长的对象则会进入到老年代。在 JVM 中有一个名为`-XX:MaxTenuringThreshold`的参数专门用来设置晋升到老年代所需要经历的 GC 次数，即在年轻代的对象经过了指定次数的 GC 后，将在下次GC时进入老年代。

因为存活时间短的对象有很多，那么势必导致较为频繁的垃圾回收。而垃圾回收时不得不对所有内存都进行扫描，但其实有一部分对象，它们存活时间很长，对他们进行扫描完全是浪费时间。因此为了提高垃圾回收效率，分区就理所当然了。

**方法区和常量池**：存储Class字节码数据的一块区域，它存储了每一个类的结构信息，例如运行时常量池、字段和方法数据、构造方法等。可以看到常量池其实是存放在方法区中的，但《Java 虚拟机规范》将常量池和方法区放在同一个等级上，这点我们知晓即可。

运行时常量池也在方法区中，用于存放Class文件中的字段，方法，接口和常量池等信息内容。

## 私有部分：PC寄存器、Java 虚拟机栈、本地方法栈

**程序计数器**：较小的内存空间，可以当成是当前线程执行的字节码的行号指示器，也就是根据这个程序计数器来决定下一步要执行啥！线程私有！在多线程中CPU切换线程怎么知道应该执行线程A中的哪一步，也就是说，之前在线程A中执行到哪了，这就要靠程序计数器去记录了。

**java虚拟机栈**：栈内存，与线程同时创建，用来存储栈帧，当线程中执行一个方法，会将方法入栈，方法中的局部变量表就会存储在栈帧中的局部变量表中

**本地方法栈**：与java虚拟机栈非常相似，有的虚拟机就把本地方法栈和java虚拟机栈合二为一，比如Sun HotSpot虚拟机！


# JVM类加载机制 https://www.cnblogs.com/chanshuyi/p/jvm_serial_07_jvm_class_loader_mechanism.html

当 Java 虚拟机将 Java 源码编译为字节码之后，虚拟机便可以将字节码读取进内存，从而进行解析、运行等整个过程，这个过程我们叫：Java 虚拟机的类加载机制。JVM 虚拟机执行class字节码的过程可以分为七个阶段：加载、验证、准备、解析、初始化、使用、卸载。

- 加载

> 主要目的是将字节码从各个位置（网络、磁盘等）转化为二进制字节流加载到内存中，接着会为这个类在JVM的方法区创建一个对应的Class对象，这个Class对象就是这个类各种数据的访问入口。

- 验证(JVM规范校验，代码逻辑校验)

> 当 JVM 加载完 Class 字节码文件并在方法区创建对应的 Class 对象之后，JVM 便会启动对该字节码流的校验，只有符合 JVM 字节码规范的文件才能被 JVM 正确执行。

- 准备（重点）

当完成字节码文件的校验之后，JVM 便会开始为类变量分配内存并初始化。这里需要注意两个关键点，即内存分配的对象以及初始化的类型。






















