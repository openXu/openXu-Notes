
热修复技术在当前Android开发中使用非常广泛，市面上关于热修复的框架非常多，其中很多都是大厂开源的。由于Android平台版本和厂商的差异性，自己实现热修复可能存在兼容性和稳定性的挑战，所以更现实的做法是根据自己的需求挑选一个合适自己的框架使用，但是在使用之前我们应该简单的了解一下其实现原理才能更好的选择和使用，最关键的问题面试官不会问你会不会用热修复框架，而是让你回答原理。

# 1. 热修复框架现状

最先开始的阿里手淘的Dexposed针对Android Dalvik虚拟机运行时的Java Method Hook技术，对底层Dalvik结构过于依赖，最终无法兼容Android 5.0以后ART虚拟机。

后来支付宝提出新的热修复方案Andfix，它也是一种底层结构替换的方案，能实现实时生效及时修复，做到了Dalvik、ART全版本兼容。

阿里百川结合手淘使用Andfix的经验，推出了Hotfix方案。由于作为基石的Andfix稳定性不好，需要改造代码，且只能提供代码层面的修复，对资源和so的修复未能实现。

除了阿里系之外，比较著名的热修复还有：腾讯QQ空间超级补丁技术、微信的Tinker、饿了么Amigo、美团Robust等。不过各有各的局限性，或者不够稳定，或者补丁过大，或者效率低下，或者使用繁琐，大部分技术上看起来可行，但实际体验并不好。

2017年6月阿里巴巴手机淘宝技术团队联合阿里云发布了新一代非侵入式热修复方案Sophix，支持代码、资源、so修复，但是不支持增加四大组件，安全性和易用性非常高，接入成本低但是商业收费。

不管使用什么框架，我们需要考虑的无非是3种情况，需不需要修复代码、是否需要修复资源文件、是否替换so文件。而这三种情况中，代码修复是一个热修复框架不可或缺的部分，下面简单介绍3中情况的实现原理。

# 2. 代码修复

应用程序上线时难免会有一些方法抛出异常但没有测试出来，导致上线后大面积崩溃，这时候我们应该打一个补丁包让用户无感知下载实现修复，而不是告诉用户为了修复这个bug要升级重新安装。怎样修复类及方法层面的bug，主要有两大方案：

- 腾讯系的类加载方案（Qzone超级补丁、QFix、微信Tinker）

> 该方案原理是在app重新启动后让ClassLoader加载新的类，由于app运行过程中，需要修复的类可能已经被记载过了，所以需要在重启时，在还没有走到bug类业务逻辑之前抢先加载补丁中的新类，这样后续访问这个类时就会加载修复过的类。具体实现是重新编排包中dex顺序，是基于dex文件级别的类插桩方案，使得系统可以自然的识别这个顺序以实现类覆盖的目的。特点是**冷启动修复，修复范围广限制少**。

- 阿里系的底层替换方案（Andfix、HotFix）

> 该方案原理是在已经加载了的类中直接替换掉原有方法，是在原来类的基础上进行修改，因此无法实现对原有类进行方法和字段的增加。因为这会导致内存中方法和字段的索引变化，这是这个方案的固有限制。由于依赖修改虚拟机方法实体的具体字段，比如修改Dalvik方法的jni函数指针、改类或方法的访问权限等，但由于手机厂商可以对底层源码进行改造，虚拟机中方法对应的ArtMethod结构体和开源代码里的结构可能不一致，这便是**不稳定**的根源。该方案特点是**实时修复，加载轻快，立即见效**

阿里系最后推出的**Sophix混合了上面两种方案**，实现优势互补，可以灵活的根据实际情况自动切换。


- 美团Robust Instant Run 热插拔原理


https://www.cnblogs.com/popfisher/p/8543973.html



- 看公司的项目需求，满足公司项目需求这是必要的一步，这里说的满足，并不一定要完全的超预期还要符合下面的几点要求。
- 尽量选择大厂并且项目有专门团队在维护，而且最近一直在维护。（因为不断的维护，这样可以减小入坑的机会同时受众广，框架会得到很好的验证）
- 尽量选择学习成本较低的一个。（这种一般选择文档清晰，使用受众广的出了问题方便排查）

tinker 是腾讯大厂的一个成熟的开源项目,在github上有自己的维护地址：https://github.com/Tencent/tinker 项目目前14k star 足可见还是让开发者普遍接受的。


